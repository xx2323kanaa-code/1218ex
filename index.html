<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>DIY + Hand PNG Overlay (Fusion v0)</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  overflow: hidden;
  height: 100%;
}

/* ===== STAGE ===== */
#stage {
  position: relative;
  width: 100vw;
  height: 100vh;
}

/* ===== CAMERA ===== */
#video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ===== HAND IMAGE (PNG) ===== */
#handImg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  pointer-events: none;
  transition: filter 0.2s ease, opacity 0.2s ease;
}

/* ===== OVERLAY (bbox / HUD) ===== */
#overlay {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

/* ===== MENU ===== */
#menu {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(0,0,0,0.65);
  color: #fff;
  padding: 10px;
  border-radius: 10px;
  font-size: 13px;
}
#menu button {
  display: block;
  margin: 4px 0;
  width: 100%;
}

/* ===== HUD DEBUG ===== */
#hud {
  position: fixed;
  left: 10px;
  bottom: 10px;
  background: rgba(0,0,0,0.7);
  color: #0f0;
  padding: 8px;
  font-size: 12px;
  border-radius: 6px;
  display: none;
  white-space: pre;
}
</style>
</head>

<body>

<div id="stage">
  <video id="video" autoplay muted playsinline></video>
  <img id="handImg" src="img/hand_open.png" />
  <canvas id="overlay"></canvas>
</div>

<div id="menu">
  <button onclick="setPose('open')">OPEN</button>
  <button onclick="setPose('miniopen')">MINI OPEN</button>
  <button onclick="setPose('hold')">HOLD</button>
  <button onclick="setPose('egg')">EGG</button>
  <button onclick="toggleHUD()">HUD DEBUG</button>
</div>

<div id="hud"></div>

<script>
/* ===============================
   STATE
================================ */
let state = {
  pose: "open",
  recognition: true,
  hud: false,
  lockTimer: null,
  lastEvent: "-"
};

/* ===============================
   HAND IMAGE CONTROL
================================ */
function updateHandImage() {
  const img = document.getElementById("handImg");

  if (state.pose === "open") {
    img.src = "img/hand_open.png";
    img.style.filter = "none";
    img.style.opacity = "1";
  }

  if (state.pose === "miniopen") {
    img.src = "img/hand_open.png";
    img.style.filter =
      "drop-shadow(0 0 25px rgba(0,180,255,0.7))";
    img.style.opacity = "0.95";
  }

  if (state.pose === "hold") {
    img.src = "img/hand_hold.png";
    img.style.filter =
      "drop-shadow(0 0 30px rgba(255,255,0,0.8))";
    img.style.opacity = "1";
  }

  if (state.pose === "egg") {
    img.src = "img/hand_open.png";
    img.style.filter = "none";
    img.style.opacity = "0.8";
  }

  updateHUD();
}

/* ===============================
   POSE SET (COCOからも呼ばれる)
================================ */
function setPose(pose) {
  state.pose = pose;
  state.lastEvent = `POSE → ${pose}`;
  updateHandImage();

  if (pose === "hold") {
    autoLockStopRecognition();
  }
}

/* ===============================
   AUTO LOCK (5 sec stop)
================================ */
function autoLockStopRecognition() {
  if (!state.recognition) return;

  state.recognition = false;
  state.lastEvent = "Recognition STOP (auto-lock)";
  updateHUD();

  clearTimeout(state.lockTimer);
  state.lockTimer = setTimeout(() => {
    state.recognition = true;
    state.lastEvent = "Recognition RESUME";
    updateHUD();
  }, 5000); // ★ 5秒
}

/* ===============================
   HUD DEBUG
================================ */
function toggleHUD() {
  state.hud = !state.hud;
  document.getElementById("hud").style.display =
    state.hud ? "block" : "none";
  updateHUD();
}

function updateHUD() {
  if (!state.hud) return;
  const hud = document.getElementById("hud");
  hud.textContent =
`HUD DEBUG
pose: ${state.pose}
recognition: ${state.recognition}
lastEvent: ${state.lastEvent}
`;
}

/* ===============================
   CAMERA INIT
================================ */
async function initCamera() {
  const video = document.getElementById("video");
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" },
    audio: false
  });
  video.srcObject = stream;
}
initCamera();

/* ===============================
   COCO SSD 接続ポイント
================================
v112 の COCO 判定結果を
ここで setPose() に接続するだけ。

例:
if (detectedPose === "lock") {
  setPose("hold");
}
================================ */
</script>

</body>
</html>
