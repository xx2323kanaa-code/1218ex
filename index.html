<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>DIY Fusion Experiment (COCO + HUD)</title>

<!-- ===== TensorFlow / COCO ===== -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  overflow: hidden;
  height: 100%;
}

/* ===== STAGE ===== */
#stage {
  position: relative;
  width: 100vw;
  height: 100vh;
}

/* ===== CAMERA ===== */
#video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ===== HAND PNG ===== */
#handImg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  pointer-events: none;
  opacity: 0.7;                 /* ★ 半透明 */
  transition: filter 0.2s ease;
}

/* ===== OVERLAY ===== */
#overlay {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

/* ===== MENU ===== */
#menu {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(0,0,0,0.65);
  color: #fff;
  padding: 10px;
  border-radius: 10px;
  font-size: 13px;
}
#menu button {
  display: block;
  margin: 4px 0;
  width: 100%;
}

/* ===== HUD ===== */
#hud {
  position: fixed;
  left: 10px;
  bottom: 10px;
  background: rgba(0,0,0,0.75);
  color: #0f0;
  padding: 8px;
  font-size: 12px;
  border-radius: 6px;
  display: none;
  white-space: pre;
}
</style>
</head>

<body>

<div id="stage">
  <video id="video" autoplay muted playsinline></video>
  <img id="handImg" src="hand_open.png" />
  <canvas id="overlay"></canvas>
</div>

<div id="menu">
  <button onclick="setPose('open')">OPEN</button>
  <button onclick="setPose('miniopen')">MINI OPEN</button>
  <button onclick="setPose('hold')">HOLD</button>
  <button onclick="toggleHUD()">HUD DEBUG</button>
</div>

<div id="hud"></div>

<script>
/* ===============================
   STATE
================================ */
let state = {
  pose: "open",
  recognition: true,
  hud: false,
  lastEvent: "-",
  cocoReady: false,
  detections: []
};

let model = null;
const video = document.getElementById("video");
const canvas = document.getElementById("overlay");
const ctx = canvas.getContext("2d");

/* ===============================
   HAND IMAGE
================================ */
function updateHandImage() {
  const img = document.getElementById("handImg");

  if (state.pose === "open") {
    img.src = "hand_open.png";
    img.style.filter = "none";
  }

  if (state.pose === "miniopen") {
    img.src = "hand_open.png";
    img.style.filter =
      "drop-shadow(0 0 25px rgba(0,180,255,0.7))";
  }

  if (state.pose === "hold") {
    img.src = "hand_hold.png";
    img.style.filter =
      "drop-shadow(0 0 30px rgba(255,255,0,0.8))";
  }

  updateHUD();
}

function setPose(pose) {
  state.pose = pose;
  state.lastEvent = `POSE → ${pose}`;
  updateHandImage();
}

/* ===============================
   HUD
================================ */
function toggleHUD() {
  state.hud = !state.hud;
  document.getElementById("hud").style.display =
    state.hud ? "block" : "none";
  updateHUD();
}

function updateHUD() {
  if (!state.hud) return;

  document.getElementById("hud").textContent =
`HUD DEBUG
pose: ${state.pose}
recognition: ${state.recognition}
COCO: ${state.cocoReady}
detections: ${state.detections.length}
lastEvent: ${state.lastEvent}`;
}

/* ===============================
   CAMERA
================================ */
async function initCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" },
    audio: false
  });
  video.srcObject = stream;

  video.onloadedmetadata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
  };
}

/* ===============================
   COCO INIT
================================ */
async function initCOCO() {
  model = await cocoSsd.load();
  state.cocoReady = true;
  state.lastEvent = "COCO loaded";
  updateHUD();
  detectLoop();
}

/* ===============================
   DETECTION LOOP
================================ */
async function detectLoop() {
  if (!state.recognition || !model) {
    requestAnimationFrame(detectLoop);
    return;
  }

  const predictions = await model.detect(video);
  state.detections = predictions;

  drawBoxes(predictions);
  updateHUD();

  requestAnimationFrame(detectLoop);
}

/* ===============================
   DRAW BBOX
================================ */
function drawBoxes(preds) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.strokeStyle = "lime";
  ctx.lineWidth = 2;
  ctx.font = "14px monospace";
  ctx.fillStyle = "lime";

  preds.forEach(p => {
    const [x, y, w, h] = p.bbox;
    ctx.strokeRect(x, y, w, h);
    ctx.fillText(
      `${p.class} ${Math.round(p.score * 100)}%`,
      x,
      y > 10 ? y - 5 : 10
    );
  });
}

/* ===============================
   START
================================ */
(async () => {
  await initCamera();
  await initCOCO();
})();
</script>

</body>
</html>
